services:
  postgres:
    image: postgres:15-alpine
    container_name: aggregator-postgres
    environment:
      POSTGRES_DB: aggregator
      POSTGRES_USER: aggregator
      POSTGRES_PASSWORD: aggregator
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aggregator"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aggregator-network

  proxy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aggregator-proxy
    environment:
      # Proxy configuration - container always listens on 8080 internally
      PROXY_ARGS: "--port 8080 --target ${TARGET_URL:-https://goggregator-test.unicity.network}"
      # Admin dashboard configuration
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin}
      # Server secret for API operations (must be hex string with even length)
      SERVER_SECRET: ${SERVER_SECRET:-0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef}
      # Logging configuration (used by logback.xml)
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      # Database configuration
      DB_URL: jdbc:postgresql://postgres:5432/aggregator
      DB_USER: aggregator
      DB_PASSWORD: aggregator
      # HikariCP connection pool configuration
      HIKARI_MAX_POOL_SIZE: ${HIKARI_MAX_POOL_SIZE:-50}
      HIKARI_MIN_IDLE: ${HIKARI_MIN_IDLE:-10}
      HIKARI_CONNECTION_TIMEOUT: ${HIKARI_CONNECTION_TIMEOUT:-30000}
      HIKARI_IDLE_TIMEOUT: ${HIKARI_IDLE_TIMEOUT:-600000}
      HIKARI_MAX_LIFETIME: ${HIKARI_MAX_LIFETIME:-1800000}
      HIKARI_VALIDATION_TIMEOUT: ${HIKARI_VALIDATION_TIMEOUT:-5000}
      HIKARI_LEAK_DETECTION_THRESHOLD: ${HIKARI_LEAK_DETECTION_THRESHOLD:-60000}
      # Log configuration
      LOG_DIR: /var/log/aggregator
      # LOG_MAX_HISTORY: 90              # Days to keep logs (0 = unlimited, default: 90)
      # LOG_TOTAL_SIZE_CAP: 20GB         # Total size cap (0 = unlimited, default: 20GB)
      # LOG_MAX_FILE_SIZE: 100MB         # Max size per file (default: 100MB)
    ports:
      # Map host port (configurable) to container port 8080 (fixed)
      - "${PROXY_PORT:-8080}:8080"
    volumes:
      - proxy-logs:/var/log/aggregator
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - aggregator-network
    extra_hosts:
      # Allow proxy to connect to host machine (for local aggregator)
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

volumes:
  postgres-data:
  proxy-logs:

networks:
  aggregator-network:
    driver: bridge